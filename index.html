<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Browse themes — Innioasis Y1</title>

    <meta name="description" content="Browse and download Rockbox themes for the Innioasis Y1. Customize your player with community-made themes for 240p and 360p models.">
    <meta name="keywords" content="Innioasis Y1 themes, Rockbox themes Y1, Y1 UI themes, Rockbox customization">
    <meta name="author" content="Innioasis Community">

    <link rel="canonical" href="https://themes.innioasis.app/">

    <meta property="og:type" content="website">
    <meta property="og:title" content="Innioasis Y1 Rockbox Themes">
    <meta property="og:description" content="Customize your Innioasis Y1 with Rockbox themes made by the community.">
    <meta property="og:url" content="https://themes.innioasis.app/">
    <meta property="og:image" content="https://innioasis.app/y1_illustration.png">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Innioasis Y1 Rockbox Themes">
    <meta name="twitter:description" content="Download and customize Rockbox themes for the Innioasis Y1.">
    <meta name="twitter:image" content="https://innioasis.app/y1_illustration.png">

    <link rel="icon" href="y1_illustration.png">

    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        html,
        body {
            height: 100%
        }

        .wrap {
            max-width: 1200px;
            margin: 0 auto;
            margin-top: 6rem;
        }

        header h1 {
            margin: 0 0 8px 0
        }

        header p {
            margin: 0;
            color: var(--text-secondary)
        }

        .theme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 16px;
            margin-top: 18px
        }

        .theme-card {
            justify-content: center;
            border-radius: 10px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
            border: 2px solid var(--bg-card);
            position: relative;
        }

        .theme-card img {
            height: 140px;
            border-radius: 8px;
            transition: all 0.2s ease;
            width: auto;
            max-width: 250px;
        }

        .theme-card img:hover {
            scale: 1.05;
        }

        .theme-name {
            font-weight: 700;
            text-align: center
        }

        .theme-desc {
            font-size: 0.95rem;
            color: var(--text-secondary);
            text-align: center
        }

        .theme-author {
            font-size: 0.85rem;
            color: var(--text-secondary)
        }

        footer {
            margin-top: 28px;
            text-align: center;
            color: var(--text-secondary)
        }

        .muted-link {
            color: lightblue;
            text-decoration: none
        }

        @media (max-width: 600px) {
            .theme-card {
                border: none;
                border-bottom: 2px solid var(--bg-card);
                border-radius: 0;
            }

            .cast-div {
                display: flex;
            }
        }

        .os-switch {
            display: flex;
            gap: 12px;
            margin: 18px 0 8px;
        }

        #rockbox-btn {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid rgba(255, 255, 255, 0.06);
            font-weight: normal;
            padding: .875rem 2rem;
            border-radius: 8px;
            cursor: pointer;
            margin-left: 15px;
        }

        #rockbox-btn:hover {
            background: var(--bg-card);
            color: var(--primary);
        }

        .btn {
            background: var(--primary);
            color: #fff;
            padding: 8px 12px;
            border-radius: 8px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            border: none;
            font-family: Inter;
            cursor: pointer;
        }

        .btn:hover {
            background: var(--primary-dark);
        }
    </style>
</head>

<body>
    <div id="nav-root"></div>
    <div class="wrap">
        <header>
            <h1>Themes</h1>
            <p>Download themes for your Y1. Visit the <a href='https://innioasis.app/guide.html'>themes guide</a> to learn how to upload them to your
                device.</p>
        </header>

        <div class="cast-div" style="margin-top: 3rem;">
            <a href="https://innioasis.app/guide.html#c_themes" class="btn" style="font-family: Inter; padding: .875rem 2rem; font-weight: normal;"><i class="fas fa-plus" style="margin-right: 4px"></i>Create and submit themes</a>
            <a id="rockbox-btn"><i class="fas fa-external-link" style="margin-right: 8px;"></i>Rockbox themes</a>
        </div>

        <div id="direct-install-banner" style="margin-top: 2rem; padding: 16px; background: rgba(100, 200, 255, 0.1); border: 1px solid rgba(100, 200, 255, 0.3); border-radius: 8px; display: none;">
            <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;">
                <div style="flex: 1; min-width: 300px;">
                    <div style="margin-bottom: 4px;">Direct Install</div>
                    <div style="font-size: 0.9rem; color: var(--text-secondary);">Connect your Y1 and select its themes folder to install themes directly without downloading zip files.</div>
                    <div id="browser-support-warning" style="font-family: Inter; font-size: 0.85rem; color: #ff9800; margin-top: 6px; display: none;"><i class="fas fa-exclamation-triangle" style="margin-right: 4px;"></i>Your browser doesn't support Direct Install. Use Chrome, Edge, or Opera.</div>
                </div>
                <button id="choose-folder-btn" class="btn" style="font-family: Inter; padding: .875rem 1.5rem; font-weight: normal; white-space: nowrap;">
                    <i class="fas fa-folder" style="margin-right: 8px;"></i>Choose Y1 Themes Folder
                </button>
                <div id="folder-selected-indicator" style="font-size: 0.85rem; color: #4caf50; display: none;"><i class="fas fa-check-circle" style="margin-right: 4px;"></i>Folder selected</div>
            </div>
            <div id="filter-on-device" style="margin-top:8px; display:none;">
                <label style="font-size:0.95rem;color:var(--text-secondary);">
                    <input type="checkbox" id="only-on-device-checkbox" style="margin-right:8px;" /> Only show themes already on Y1
                </label>
            </div>
        </div>

        <div id="theme-grid" class="theme-grid"></div>

    </div>

    <div id="rockbox-backdrop" style="display:none;position:fixed;inset:0;background:rgba(0, 0, 0, 0.5);align-items:center;justify-content:center;z-index:1000">
        <div style="background:var(--bg-card);border-radius:12px;min-width:400px;padding:20px;display:flex;flex-direction:column;gap:16px;position:relative">
            <button id="rockbox-close" style="position:absolute;top:12px;right:12px;background:none;border:0;color:var(--text-secondary);font-size:1.2rem;cursor:pointer">
                <i class="fa-solid fa-xmark"></i>
            </button>

            <div style="font-size:1.2rem;font-weight:800">Rockbox themes</div>
            <div style="color:var(--text-secondary);font-size:.95rem">
                Choose your screen resolution
            </div>

            <button class="btn rckbox-btn" id="rb-240">240p themes</button>
            <button class="btn rckbox-btn" id="rb-360">360p themes</button>
        </div>
    </div>

    <div id="footer-root"></div>

    <script src="nav.js"></script>
    <script>
        const rbBtn = document.getElementById('rockbox-btn')
        const rbBackdrop = document.getElementById('rockbox-backdrop')
        const rbClose = document.getElementById('rockbox-close')

        const supportDirectInstall = typeof window.showDirectoryPicker === 'function';
        let selectedThemesFolder = null;

        const bannerEl = document.getElementById('direct-install-banner');
        const browserWarning = document.getElementById('browser-support-warning');
        const chooseFolderBtn = document.getElementById('choose-folder-btn');
        const folderIndicator = document.getElementById('folder-selected-indicator');
        const filterDiv = document.getElementById('filter-on-device');
        const onlyOnDeviceCheckbox = document.getElementById('only-on-device-checkbox');

        function updateOnDeviceFilter() {
            const checked = onlyOnDeviceCheckbox && onlyOnDeviceCheckbox.checked;
            const cards = document.querySelectorAll('.theme-card');
            for (const card of cards) {
                if (checked) {
                    if (!card.classList.contains('on-device')) {
                        card.style.display = 'none';
                    } else {
                        card.style.display = '';
                    }
                } else {
                    card.style.display = '';
                }
            }
        }

        if (supportDirectInstall) {
            bannerEl.style.display = 'block';
            chooseFolderBtn.onclick = async () => {
                try {
                    selectedThemesFolder = await window.showDirectoryPicker();
                    folderIndicator.style.display = 'inline-flex';
                    folderIndicator.style.alignItems = 'center';
                    const dirButtons = document.querySelectorAll('[data-direct-install-btn]');
                    dirButtons.forEach(btn => {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                        btn.style.cursor = 'pointer';
                    });

                    const cards = document.querySelectorAll('.theme-card');
                    for (const card of cards) {
                        const themeName = card.getAttribute('data-theme-name');
                        const status = card.querySelector('.theme-status');
                        const di = card.querySelector('[data-direct-install-btn]');
                        try {
                            await selectedThemesFolder.getDirectoryHandle(themeName, {
                                create: false
                            });
                            card.classList.add('on-device');
                            if (status) status.style.display = 'block';
                            if (di) {
                                di.disabled = false;
                                di.style.opacity = '1';
                                di.style.cursor = 'pointer';
                                di.innerHTML = '<i class="fa-solid fa-download"></i> Update';
                            }
                        } catch (e) {
                            card.classList.remove('on-device');
                            if (status) status.style.display = 'none';
                            if (di) {
                                if (selectedThemesFolder) {
                                    di.disabled = false;
                                    di.style.opacity = '1';
                                    di.style.cursor = 'pointer';
                                    di.innerHTML = '<i class="fa-solid fa-bolt"></i> Direct Install';
                                } else {
                                    di.disabled = true;
                                    di.style.opacity = '0.5';
                                    di.style.cursor = 'not-allowed';
                                }
                            }
                        }
                    }
                    if (filterDiv) filterDiv.style.display = 'block';
                    if (onlyOnDeviceCheckbox) {
                        onlyOnDeviceCheckbox.checked = false;
                        onlyOnDeviceCheckbox.onchange = updateOnDeviceFilter;
                    }
                    updateOnDeviceFilter();
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        alert('Failed to access folder: ' + err.message);
                    }
                }
            };
        } else {
            bannerEl.style.display = 'block';
            browserWarning.style.display = 'block';
            chooseFolderBtn.disabled = true;
            chooseFolderBtn.style.opacity = '0.5';
            chooseFolderBtn.style.cursor = 'not-allowed';
            if (filterDiv) filterDiv.style.display = 'none';
        }

        rbBtn.onclick = () => {
            rbBackdrop.style.display = 'flex'
        }
        rbClose.onclick = () => {
            rbBackdrop.style.display = 'none'
        }

        rbBackdrop.onclick = e => {
            if (e.target === rbBackdrop) rbBackdrop.style.display = 'none'
        }

        document.getElementById('rb-240').onclick = () => {
            rbBackdrop.style.display = 'none'
            window.open('https://themes.rockbox.org/index.php?target=ipodvideo')
        }

        document.getElementById('rb-360').onclick = () => {
            rbBackdrop.style.display = 'none'
            window.open('https://github.com/rockbox-y1/themes/releases/tag/for_the_gays_and_the_theys')
        }

        async function tryFetchThemes() {
            const urls = [
                'themes.json',
            ]
            for (const u of urls) {
                try {
                    const r = await fetch(u)
                    const j = await r.json()
                    console.log(j);
                    if (r.ok && j.themes) return j.themes
                } catch (e) {}
            }
            return []
        }

        function resolveScreenshotPath(path) {
            if (!path) return ''
            if (path.startsWith('http')) return path
            if (path.startsWith('./')) return 'https://raw.githubusercontent.com/y1-community/InnioasisY1Themes/main/' + path.slice(2)
            return path
        }

        function safeText(v) {
            return v ?? 'Unknown'
        }

        function githubApiUrlForFolder(folder) {
            const cleaned = (folder || '').replace(/^\.\/+/, '')
            return `https://api.github.com/repos/y1-community/InnioasisY1Themes/contents/${encodeURIComponent(cleaned)}`
        }

        async function downloadGitHubFolderAsZip(folderName, themeName, progressCallbacks) {
            const zip = new JSZip();
            const apiUrl = githubApiUrlForFolder(folderName);

            progressCallbacks?.onStart?.(`Fetching file list for ${themeName}...`);

            let files;
            try {
                const res = await fetch(apiUrl);
                if (!res.ok) {
                    throw new Error(`Failed to fetch GitHub API folder contents (${res.status})`);
                }
                files = await res.json();
            } catch (e) {
                throw new Error(`Cannot fetch folder contents: ${e.message}`);
            }

            if (!Array.isArray(files)) throw new Error('GitHub API did not return a file list.');

            const fileEntries = [];

            async function walk(entries, basePath = '') {
                for (const entry of entries) {
                    if (entry.type === 'file') {
                        fileEntries.push(entry);
                    } else if (entry.type === 'dir') {
                        const res = await fetch(entry.url);
                        if (!res.ok) {
                            console.warn('Failed to fetch subfolder', entry.path);
                            continue;
                        }
                        const nested = await res.json();
                        await walk(nested, entry.path);
                    }
                }
            }

            await walk(files);

            const totalFiles = fileEntries.length;
            if (totalFiles === 0) throw new Error('No files found in the theme folder.');

            let downloadedFiles = 0;

            for (const file of fileEntries) {
                try {
                    const beforePercent = Math.round((downloadedFiles / totalFiles) * 80);
                    progressCallbacks?.onProgress?.(`${file.path} (${downloadedFiles + 1}/${totalFiles})`, beforePercent);
                    const fileResp = await fetch(file.download_url);
                    if (!fileResp.ok) {
                        console.warn(`Failed to fetch file ${file.path}: ${fileResp.status}`);
                        downloadedFiles++;
                        progressCallbacks?.onProgress?.(`Skipped ${file.path}`, Math.round((downloadedFiles / totalFiles) * 80));
                        continue;
                    }
                    const blob = await fileResp.blob();
                    zip.file(file.path, blob);
                    downloadedFiles++;
                    progressCallbacks?.onProgress?.(`Downlding ${file.path} (${downloadedFiles}/${totalFiles})`, Math.round((downloadedFiles / totalFiles) * 80));
                } catch (e) {
                    console.warn(`Error downloading file ${file.path}:`, e);
                    downloadedFiles++;
                    progressCallbacks?.onProgress?.(`Error ${file.path}`, Math.round((downloadedFiles / totalFiles) * 80));
                }
            }

            progressCallbacks?.onProgress?.('Generating ZIP...', 80);

            const content = await zip.generateAsync({
                type: 'blob'
            }, metadata => {
                const mapped = 80 + Math.round((metadata.percent || 0) * 0.2);
                progressCallbacks?.onProgress?.(`Zipping: ${Math.round(metadata.percent || 0)}%`, mapped);
            });

            return content;
        }

        function createProgressUI(parent, oldButton, themeName) {
            const progressWrap = document.createElement('div');
            progressWrap.className = 'theme-progress';
            progressWrap.setAttribute('role', 'status');
            progressWrap.setAttribute('aria-live', 'polite');

            const row = document.createElement('div');
            row.className = 'progress-row';

            const barOuter = document.createElement('div');
            barOuter.className = 'progress-bar';
            const barInner = document.createElement('div');
            barInner.className = 'progress-bar-inner';
            barOuter.appendChild(barInner);

            const percent = document.createElement('div');
            percent.className = 'progress-percent';
            percent.textContent = '0%';

            row.appendChild(barOuter);
            row.appendChild(percent);

            const text = document.createElement('div');
            text.className = 'progress-text';
            text.textContent = `Preparing ${themeName}...`;

            progressWrap.appendChild(row);
            progressWrap.appendChild(text);

            const buttonParent = oldButton && oldButton.parentElement ? oldButton.parentElement : parent;
            buttonParent.replaceChild(progressWrap, oldButton);

            return {
                root: progressWrap,
                setProgress(pct, msg) {
                    const clamped = Math.max(0, Math.min(100, Math.round(pct)));
                    barInner.style.width = clamped + '%';
                    percent.textContent = clamped + '%';
                    if (msg) text.textContent = msg;
                },
                removeAndRestoreButton(originalButton) {
                    try {
                        const bp = progressWrap.parentElement || buttonParent;
                        if (!originalButton.parentElement) bp.appendChild(originalButton);
                        bp.replaceChild(originalButton, progressWrap);
                        const origText = originalButton.innerHTML;
                        originalButton.innerHTML = 'Downloaded ✓';
                        originalButton.disabled = false;
                        setTimeout(() => {
                            originalButton.innerHTML = origText;
                        }, 2500);
                    } catch (e) {
                        console.warn('restore button failed', e);
                    }
                },
                abortAndRestore(originalButton) {
                    try {
                        const bp = progressWrap.parentElement || buttonParent;
                        if (!originalButton.parentElement) bp.appendChild(originalButton);
                        bp.replaceChild(originalButton, progressWrap);
                        originalButton.disabled = false;
                    } catch (e) {
                        console.warn('abort restore failed', e);
                    }
                }
            };
        }

        async function directInstallTheme(theme, buttonNode) {
            if (!selectedThemesFolder) {
                alert('Please select your Y1 Themes folder first');
                return;
            }

            const card = buttonNode.closest('.theme-card');
            if (!card) return;
            const dlBtn = card.querySelector('button.btn:not([data-direct-install-btn])');
            if (dlBtn) dlBtn.style.display = 'none';
            buttonNode.disabled = true;

            const progressUI = createProgressUI(card, buttonNode, theme.name || 'theme');

            try {
                if (!theme.folder) {
                    alert('No downloadable folder info for this theme.');
                    progressUI.abortAndRestore(buttonNode);
                    return;
                }

                const themeName = (theme.name || 'theme').replace(/[^\w\d-_ ]/g, '_') || 'theme';
                const themeFolder = await selectedThemesFolder.getDirectoryHandle(themeName, {
                    create: true
                });

                const folderClean = (theme.folder || '').replace(/^\.\/+/, '');
                const apiUrl = githubApiUrlForFolder(theme.folder);

                progressUI.setProgress(5, `Fetching file list for ${theme.name}...`);

                let files;
                try {
                    const res = await fetch(apiUrl);
                    if (!res.ok) {
                        throw new Error(`Failed to fetch folder contents (${res.status})`);
                    }
                    files = await res.json();
                } catch (e) {
                    throw new Error(`Cannot fetch folder contents: ${e.message}`);
                }

                if (!Array.isArray(files)) throw new Error('GitHub API did not return a file list.');

                const fileEntries = [];

                async function walk(entries, basePath = '') {
                    for (const entry of entries) {
                        if (entry.type === 'file') {
                            fileEntries.push({
                                ...entry,
                                basePath
                            });
                        } else if (entry.type === 'dir') {
                            const res = await fetch(entry.url);
                            if (!res.ok) {
                                console.warn('Failed to fetch subfolder', entry.path);
                                continue;
                            }
                            const nested = await res.json();
                            await walk(nested, entry.path);
                        }
                    }
                }

                await walk(files);

                const totalFiles = fileEntries.length;
                if (totalFiles === 0) throw new Error('No files found in the theme folder.');

                let downloadedFiles = 0;

                for (const file of fileEntries) {
                    try {
                        const relativePath = file.path.replace(folderClean + '/', '');
                        const pathParts = relativePath.split('/');
                        const fileName = pathParts[pathParts.length - 1];
                        let currentFolder = themeFolder;

                        for (let i = 0; i < pathParts.length - 1; i++) {
                            currentFolder = await currentFolder.getDirectoryHandle(pathParts[i], {
                                create: true
                            });
                        }

                        const beforePercent = 5 + Math.round((downloadedFiles / totalFiles) * 85);
                        progressUI.setProgress(beforePercent, `Downloading ${relativePath} (${downloadedFiles + 1}/${totalFiles})`);

                        const fileResp = await fetch(file.download_url);
                        if (!fileResp.ok) {
                            console.warn(`Failed to fetch file ${file.path}: ${fileResp.status}`);
                            downloadedFiles++;
                            progressUI.setProgress(5 + Math.round((downloadedFiles / totalFiles) * 85), `Skipped ${relativePath}`);
                            continue;
                        }

                        const blob = await fileResp.blob();
                        const fileHandle = await currentFolder.getFileHandle(fileName, {
                            create: true
                        });
                        const writable = await fileHandle.createWritable();
                        await writable.write(blob);
                        await writable.close();

                        downloadedFiles++;
                        progressUI.setProgress(5 + Math.round((downloadedFiles / totalFiles) * 85), `Installed ${relativePath}`);
                    } catch (e) {
                        console.warn(`Error downloading file ${file.path}:`, e);
                        downloadedFiles++;
                        progressUI.setProgress(5 + Math.round((downloadedFiles / totalFiles) * 85), `Error ${file.path}`);
                    }
                }

                progressUI.setProgress(95, 'Finalizing...');
                progressUI.removeAndRestoreButton(buttonNode);
                try {
                    const dlBtn2 = card.querySelector('button.btn:not([data-direct-install-btn])');
                    if (dlBtn2) dlBtn2.style.display = '';
                } catch (e) {}
                try {
                    const cardEl = buttonNode.closest('.theme-card');
                    if (cardEl) {
                        cardEl.classList.add('on-device');
                        const statusEl = cardEl.querySelector('.theme-status');
                        if (statusEl) statusEl.style.display = 'block';
                    }
                    setTimeout(() => {
                        try {
                            buttonNode.innerHTML = '<i class="fa-solid fa-download"></i> Update';
                            buttonNode.disabled = false;
                            buttonNode.style.opacity = '1';
                            buttonNode.style.cursor = 'pointer';
                        } catch (e) {}
                    }, 2600);
                    try {
                        if (onlyOnDeviceCheckbox && onlyOnDeviceCheckbox.checked) updateOnDeviceFilter();
                    } catch (e) {}
                } catch (e) {}

            } catch (err) {
                console.error('Direct install failed', err);
                alert(`Failed to install theme "${theme.name}": ${err.message || err}`);
                progressUI.abortAndRestore(buttonNode);
                try {
                    const dlBtn3 = card.querySelector('button.btn:not([data-direct-install-btn])');
                    if (dlBtn3) dlBtn3.style.display = '';
                } catch (e) {}
            }
        }

        async function downloadTheme(theme, buttonNode) {
            const card = buttonNode.closest('.theme-card');
            if (!card) return;
            const diBtn = card.querySelector('[data-direct-install-btn]');
            if (diBtn) diBtn.style.display = 'none';
            buttonNode.disabled = true;

            const progressUI = createProgressUI(card, buttonNode, theme.name || 'theme');
            try {
                if (!theme.folder) {
                    alert('No downloadable folder info for this theme.');
                    progressUI.abortAndRestore(buttonNode);
                    return;
                }

                const callbacks = {
                    onStart: (msg) => {
                        progressUI.setProgress(0, msg);
                    },
                    onProgress: (msg, percent) => {
                        progressUI.setProgress(percent || 0, msg || '');
                    }
                };

                const zipBlob = await downloadGitHubFolderAsZip(theme.folder, theme.name, callbacks);

                const a = document.createElement('a');
                a.href = URL.createObjectURL(zipBlob);
                const safe = (theme.name || 'theme').replace(/[^\w\d-_ ]/g, '_') || 'theme';
                a.download = `${safe}.zip`;
                document.body.appendChild(a);
                a.click();
                a.remove();

                progressUI.removeAndRestoreButton(buttonNode);
                try {
                    const diBtn2 = card.querySelector('[data-direct-install-btn]');
                    if (diBtn2) diBtn2.style.display = '';
                } catch (e) {}
            } catch (err) {
                console.error('Download failed', err);
                alert(`Failed to download theme "${theme.name}": ${err.message || err}`);
                progressUI.abortAndRestore(buttonNode);
                try {
                    const diBtn3 = card.querySelector('[data-direct-install-btn]');
                    if (diBtn3) diBtn3.style.display = '';
                } catch (e) {}
            }
        }

        function handleHashAutoDownload() {
            const hash = location.hash.replace('#', '').toLowerCase()
            if (!hash) return

            const targetCard = document.getElementById(hash)
            if (!targetCard) return

            targetCard.scrollIntoView({
                behavior: 'instant',
                block: 'center'
            })

            const downloadBtn = targetCard.querySelector('.btn')
            if (downloadBtn && !downloadBtn.disabled) {
                setTimeout(() => {
                    downloadBtn.click()
                }, 300)
            }
        }

        function createCard(theme) {
            const c = document.createElement('article');
            c.className = 'theme-card';
            if (theme.name === "MelodyMuncher") c.id = 'melodymuncher';
            const safeThemeName = (theme.name || 'theme').replace(/[^\w\d-_ ]/g, '_') || 'theme';
            c.setAttribute('data-theme-name', safeThemeName);

            const statusBadge = document.createElement('div');
            statusBadge.className = 'theme-status';
            statusBadge.style.display = 'none';
            statusBadge.style.position = 'absolute';
            statusBadge.style.top = '8px';
            statusBadge.style.right = '8px';
            statusBadge.style.background = '#4caf50';
            statusBadge.style.color = '#fff';
            statusBadge.style.padding = '4px 8px';
            statusBadge.style.borderRadius = '999px';
            statusBadge.style.fontSize = '0.8rem';
            statusBadge.style.fontWeight = '700';
            statusBadge.textContent = 'Already on your Y1';
            c.appendChild(statusBadge);

            const img = document.createElement('img');
            img.src = resolveScreenshotPath(theme.screenshot);
            img.alt = safeText(theme.name);
            img.onerror = function() {
                this.src = 'placeholder.png'
            };

            const n = document.createElement('a');
            n.className = 'theme-name';
            n.href = `theme.html?theme=${encodeURIComponent(theme.name || '')}`;
            n.textContent = safeText(theme.name);

            const d = document.createElement('div');
            d.className = 'theme-desc';
            d.textContent = safeText(theme.description);

            const a = document.createElement('div');
            a.className = 'theme-author';
            if (!theme.author) {
                a.textContent = 'Unknown author';
            } else if (theme.author === 'Innioasis') {
                a.innerHTML = `by <a href="https://innioasis.com" target="_blank" rel="noopener">Innioasis</a>`;
            } else if (theme.author === 'u/ope-nz | Normal-Curve-1642') {
                a.innerHTML = `by <a href="https://reddit.com/u/Normal-Curve-1642" target="_blank" rel="noopener">Normal-Curve-1642</a>`;
            } else {
                a.innerHTML = `by <a href="https://reddit.com/${theme.author}" target="_blank" rel="noopener">${theme.author}</a>`;
            }

            const bd = document.createElement('div');
            bd.style.display = 'flex';
            bd.style.gap = '8px';

            const dl = document.createElement('button');
            dl.className = 'btn';
            const backgroundimg = '3.png' || 'Background1.png' || '@Pris_itemSelectedBackground.png';
            dl.style.backgroundImage = `url("https://raw.githubusercontent.com/y1-community/InnioasisY1Themes/main/${theme.folder.replace(/^\.\/+/, '')}/${backgroundimg}")`;
            dl.style.backgroundSize = 'cover';
            dl.style.backgroundPosition = 'center';
            dl.style.fontWeight = 'normal';
            dl.style.marginTop = 'auto';
            dl.innerHTML = '<i class="fa-solid fa-download"></i> Download';
            dl.type = 'button';
            dl.onclick = () => downloadTheme(theme, dl);

            dl.style.fontFamily = 'Inter, sans-serif';

            const di = document.createElement('button');
            di.className = 'btn';
            di.style.fontWeight = 'normal';
            di.style.marginTop = 'auto';
            di.style.opacity = '0.5';
            di.style.cursor = 'not-allowed';
            di.disabled = true;
            di.innerHTML = '<i class="fa-solid fa-bolt"></i> Direct Install';
            di.type = 'button';
            di.onclick = () => directInstallTheme(theme, di);
            di.setAttribute('data-direct-install-btn', 'true');
            if (selectedThemesFolder) {
                di.disabled = false;
                di.style.opacity = '1';
                di.style.cursor = 'pointer';
            }

            try {
                if (!supportDirectInstall) {
                    di.style.display = 'none';
                    di.disabled = true;
                    di.style.opacity = '0';
                    di.style.cursor = 'default';
                    di.setAttribute('aria-hidden', 'true');
                }
            } catch (e) {}

            bd.append(dl, di);
            c.append(img, n, d, a, bd);
            return c;
        }


        async function load() {
            const grid = document.getElementById('theme-grid')
            const themes = await tryFetchThemes()
            if (!themes.length) {
                grid.innerHTML = '<p style="grid-column:1/-1;text-align:center;color:#94a3b8">Unable to load themes</p>'
                return
            }
            themes.forEach(t => grid.appendChild(createCard(t)))

            handleHashAutoDownload()
        }


        load()
    </script>
</body>

</html>